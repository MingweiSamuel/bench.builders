---
import { SITES } from '../data';

interface Props {
  highlightSiteId?: number,
}

const { highlightSiteId } = Astro.props;

const sites = await SITES;
---

<bench-map data-sites={JSON.stringify(sites)} data-highlight={highlightSiteId}>
  <div style="height: 600px;"></div>
</bench-map>
<script>
  import "leaflet/dist/leaflet.css";
  import marker from "leaflet/dist/images/marker-icon.png";
  import marker2x from "leaflet/dist/images/marker-icon-2x.png";
  import shadow from "leaflet/dist/images/marker-shadow.png";
  import L from "leaflet";
  import type { Site } from "../data";

  class BenchMap extends HTMLElement {
    connectedCallback() {
      // Read the message from the data attribute.
      const sites: Site[] = JSON.parse(this.dataset.sites!);

      const icon = L.icon({
        iconUrl: marker.src,
        iconRetinaUrl: marker2x.src,
        shadowUrl: shadow.src,

        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        tooltipAnchor: [16, -28],
        shadowSize: [41, 41],
      });

      const div = this.getElementsByTagName('div')[0]!;
      const map = L.map(div, {
        center: [37.83, -122.3],
        zoom: 11,
        // layers: [osm],
        maxBounds: [
          [37.2, -122.7],
          [38.2, -121.7],
        ],
        maxBoundsViscosity: 1.0
      });
      // L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      // TODO(mingwei): dark/light mode
      L.tileLayer("tile.d.{z}.{x}.{y}.{r}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);

      for (const site of sites) {
        const marker = L.marker([site.lat, site.lon], {
          icon,
        }).addTo(map);
        // TODO(mingwei): prevent XSS.
        const popup = marker.bindPopup(`<a href="/s/${site.id}">${site.revGeocode}</a>`);
        if (this.dataset.highlight === `${site.id}`) {
          popup.openPopup();
        }
      }
    }
  }

  customElements.define('bench-map', BenchMap);
</script>
